```{r}
stopifnot(exists("target_genes"))
stopifnot(exists("file_prefix"))
stopifnot(exists("tau_df"))
stopifnot(exists("gtex_mat"))
stopifnot(exists("tabula_obj"))

if(!exists("perform_significance_test")){
  perform_significance_test=FALSE
}
```

## Tau heatmap

In order to make the figure more readable, we only show genes with tau > 0.6.

```{r}
genes_tau = tau_df[intersect(target_genes, rownames(tau_df)), ] |>
  dplyr::filter(tau > 0.6) |>
  dplyr::select(-tau)

heatmap_png = paste0(file_prefix, ".tau.heatmap.png")

ignored = draw_heatmap_png(heatmap_png, 
  as.matrix(genes_tau), 
  name="tau", 
  show_row_names=TRUE, 
  show_column_names=TRUE, 
  cluster_rows=TRUE, 
  cluster_columns=TRUE,
  show_column_dend=TRUE,
  save_rds=FALSE)
include_graphics(heatmap_png)
```

## Protein Atlas GTEx heatmap

```{r}
genes_gtex = gtex_mat[intersect(target_genes, rownames(gtex_mat)), ]

if(nrow(genes_gtex) >= 30){
  cat("In order to make the figure more readable, we only show genes with max nTPM > 10.\n")
  genes_gtex = genes_gtex[apply(genes_gtex, 1, max) > 10,,drop=FALSE ]
}

genes_gtex=calc_z_scores(genes_gtex)

heatmap_png = paste0(file_prefix, ".gtex.heatmap.png")

ignored = draw_heatmap_png(heatmap_png, 
  as.matrix(genes_gtex), 
  name="zscore(GTEx nTPM)", 
  show_row_names=TRUE, 
  show_column_names=TRUE, 
  cluster_rows=TRUE, 
  cluster_columns=TRUE,
  show_column_dend=TRUE,
  save_rds=FALSE)
include_graphics(heatmap_png)
```

```{r eval=perform_significance_test}
df = dataRankTest(selectedGenes=target_genes, 
                  alldata=gtex_mat, 
                  universGenes=NULL) |>
  dplyr::arrange(p)

print_table(df, byDT=TRUE, row.names=TRUE)
```

## Tabula Sapiens Activity Score

Now calculated the gene activity score using Seurat function `AddModuleScore`.

```{r}
score_genes=list(genes_tabula = intersect(target_genes, rownames(tabula_obj)))

score_meta_rds=paste0(file_prefix, ".ActivityScore.meta.rds")
if(!file.exists(score_meta_rds)){
  score_obj=AddModuleScore(object=tabula_obj, 
                            features=score_genes, 
                            name="ActivityScore", 
                            assay="RNA",
                            slot="data",
                            nbin=24)
  saveRDS(score_obj@meta.data, score_meta_rds)
}else{
  score_obj=tabula_obj
  score_obj@meta.data=readRDS(score_meta_rds)
}
```

### UMAP plot

```{r}
g=FeaturePlot_scCustom(score_obj, 
            features='ActivityScore1', 
            pt.size=0.5,
            aspect_ratio=1,
            min.cutoff=quantile(score_obj@meta.data$ActivityScore1, 0.01),
            max.cutoff=quantile(score_obj@meta.data$ActivityScore1, 0.99)) +
            xlab("UMAP_1") + ylab("UMAP_2") + 
            theme(plot.title=element_blank())
ActivityScore_png=paste0(file_prefix, ".tabula.umap.png")
ggsave(ActivityScore_png, g, width=5, height=5, units="in", dpi=300, bg="white")
include_graphics(ActivityScore_png)
```

### Violin plot by tissue

```{r}
gd=FetchData(score_obj, c("tissue", "ActivityScore1"))

gd$tissue=factor(gd$tissue, levels=rev(names(sort(tapply(gd[,"ActivityScore1"], gd$tissue, median)))))

g=ggplot(gd, aes(x=tissue, y=ActivityScore1)) +
  geom_violin(scale="width") + 
  geom_boxplot(outliers=FALSE, width=0.4, color="white", fill="black", linewidth=0.2) +
  ylab("Activity Score") +  
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.x=element_blank(),
        plot.title = element_blank(),
        legend.position = "none")

ActivityScore_png=paste0(file_prefix, ".tabula.violin.tissue.png")
ggsave(ActivityScore_png, g, width=7, height=5, units="in", dpi=300, bg="white")
include_graphics(ActivityScore_png)       
```   

### Violin plot by cell types 

The cell types are ranked by median activity score.

```{r}
gd=FetchData(score_obj, c("cell_type", "ActivityScore1"))

gd$cell_type=factor(gd$cell_type, levels=rev(names(sort(tapply(gd[,"ActivityScore1"], gd$cell_type, median)))))

g=ggplot(gd, aes(x=cell_type, y=ActivityScore1)) +
  geom_violin(scale="width") + 
  geom_boxplot(outliers=FALSE, width=0.4, color="white", fill="black", linewidth=0.2) +
  ylab("Activity Score") + 
  scale_color_manual(values=c("black", "red")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.x=element_blank(),
        plot.title = element_blank(),
        legend.position = "none")

ActivityScore_png=paste0(file_prefix, ".tabula.violin.cell_type.png")
ggsave(ActivityScore_png, g, width=10, height=7, units="in", dpi=300, limitsize=FALSE, bg="white")
include_graphics(ActivityScore_png)
```
