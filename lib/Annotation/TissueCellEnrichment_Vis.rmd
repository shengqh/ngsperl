```{r}
stopifnot(exists("target_genes"))
stopifnot(exists("file_prefix"))

if(perform_tau) stopifnot(exists("tau_df"))
if(perform_gtex) stopifnot(exists("gtex_mat"))
if(perform_tabula) stopifnot(exists("tabula_obj"))

if(!exists('transpose_heatmap')){
  transpose_heatmap=FALSE
}

if(!exists("tau_threshold")){
  tau_threshold=0.6
}

if(!exists("tau_filter_tissue")){
  tau_filter_tissue=FALSE
}

if(!exists("perform_significance_test")){
  perform_significance_test=FALSE
}
```

```{r eval=perform_tau}
cat("\n## Tau heatmap\n\n")

genes_tau = tau_df[intersect(target_genes, rownames(tau_df)), ] |>
  dplyr::filter(tau >= tau_threshold) |>
  dplyr::select(-tau)

cat("\nIn order to make the figure more readable, we only show ", nrow(genes_tau), " genes with tau >= ", tau_threshold, ".")

if(tau_filter_tissue){
  cat(paste0(" We also filter out tissues without any gene with tau >= ", tau_threshold, ".\n"))
  genes_tau = genes_tau[, apply(genes_tau, 2, max) >= tau_threshold, drop=FALSE]
}

print_table(genes_tau, byDT=TRUE, row.names=TRUE)

if(transpose_heatmap){
  heatmap_genes_tau=t(genes_tau)
}else{
  heatmap_genes_tau=genes_tau
}

heatmap_png = paste0(file_prefix, ".tau.heatmap.png")

ignored = draw_heatmap_png(heatmap_png, 
  as.matrix(heatmap_genes_tau), 
  name="tau", 
  show_row_names=TRUE, 
  show_column_names=TRUE, 
  cluster_rows=TRUE, 
  cluster_columns=TRUE,
  show_column_dend=TRUE,
  save_rds=FALSE,
  add_height_inch=1)
include_graphics(heatmap_png)
```

```{r eval=perform_tau}
library(UpSetR)

#genes_tau is a data frame with row as genes and column as tissues, value as tau
#we will convert it to a list of genes for each tissue with tau >= tau_threshold
genes_list = list()
for(tissue in colnames(genes_tau)){
  genes_list[[tissue]] = rownames(genes_tau)[genes_tau[[tissue]] >= tau_threshold]
}
count_tbl=data.frame(Tissue=names(genes_list), EnrichedGenes=sapply(genes_list, length)) |>
  dplyr::arrange(desc(EnrichedGenes))

cat("\n## Tissue specific gene count table\n\n")

print_table(count_tbl, byDT=TRUE, row.names=FALSE)

cat("\n## Tissue specific gene Upset plot\n\n")

upset_png = paste0(file_prefix, ".tau.upset.png")
png(upset_png, width=5, height=5, units="in", res=300) 
g = upset(fromList(genes_list), 
     sets = names(genes_list),
     keep.order = FALSE,
     order.by = "freq",
     mb.ratio = c(0.3, 0.7))
print(g)
ignored=dev.off()
include_graphics(upset_png)
```

```{r eval=perform_gtex}
cat("\n## Protein Atlas GTEx heatmap\n\n")

genes_gtex = gtex_mat[intersect(target_genes, rownames(gtex_mat)), ]

if(nrow(genes_gtex) >= 30){
  cat("In order to make the figure more readable, we only show ", nrow(genes_gtex), " genes with max nTPM > 10.\n")
  genes_gtex = genes_gtex[apply(genes_gtex, 1, max) > 10,,drop=FALSE ]
}

genes_gtex=calc_z_scores(genes_gtex)

if(transpose_heatmap){
  genes_gtex=t(genes_gtex)
}

heatmap_png = paste0(file_prefix, ".gtex.heatmap.png")

ignored = draw_heatmap_png(heatmap_png, 
  as.matrix(genes_gtex), 
  name="zscore(GTEx nTPM)", 
  show_row_names=TRUE, 
  show_column_names=TRUE, 
  cluster_rows=TRUE, 
  cluster_columns=TRUE,
  show_column_dend=TRUE,
  save_rds=FALSE,
  add_height_inch=2)
include_graphics(heatmap_png)
```

```{r eval=perform_gtex & perform_significance_test}
df = dataRankTest(selectedGenes=target_genes, 
                  alldata=gtex_mat, 
                  universGenes=NULL) |>
  dplyr::arrange(p)

print_table(df, byDT=TRUE, row.names=TRUE)
```

```{r}
cat("\n## Tabula Sapiens Activity Score\n\n")
cat("Now calculated the gene activity score using Seurat function `AddModuleScore`.\n")

score_genes=list(genes_tabula = intersect(target_genes, rownames(tabula_obj)))

score_meta_rds=paste0(file_prefix, ".ActivityScore.meta.rds")
if(!file.exists(score_meta_rds)){
  score_obj=AddModuleScore(object=tabula_obj, 
                            features=score_genes, 
                            name="ActivityScore", 
                            assay="RNA",
                            slot="data",
                            nbin=24)
  saveRDS(score_obj@meta.data, score_meta_rds)
}else{
  score_obj=tabula_obj
  score_obj@meta.data=readRDS(score_meta_rds)
}

cat("\n### UMAP of Activity score\n\n")

g=FeaturePlot_scCustom(score_obj, 
            features='ActivityScore1', 
            pt.size=0.5,
            aspect_ratio=1,
            min.cutoff=quantile(score_obj@meta.data$ActivityScore1, 0.01),
            max.cutoff=quantile(score_obj@meta.data$ActivityScore1, 0.99)) +
            xlab("UMAP_1") + ylab("UMAP_2") + 
            theme(plot.title=element_blank())
ActivityScore_png=paste0(file_prefix, ".tabula.umap.png")
ggsave(ActivityScore_png, g, width=5, height=5, units="in", dpi=300, bg="white")
include_graphics(ActivityScore_png)

cat("\n### Violin plot by tissue ranked by median activity score\n\n")

gd=FetchData(score_obj, c("tissue", "ActivityScore1"))

gd$tissue=factor(gd$tissue, levels=rev(names(sort(tapply(gd[,"ActivityScore1"], gd$tissue, median)))))

g=ggplot(gd, aes(x=tissue, y=ActivityScore1)) +
  geom_violin(scale="width") + 
  geom_boxplot(outliers=FALSE, width=0.4, color="white", fill="black", linewidth=0.2) +
  ylab("Activity Score") +  
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.x=element_blank(),
        plot.title = element_blank(),
        legend.position = "none")

ActivityScore_png=paste0(file_prefix, ".tabula.violin.tissue.png")
ggsave(ActivityScore_png, g, width=5, height=3, units="in", dpi=300, bg="white")
include_graphics(ActivityScore_png)       

cat("\n### Violin plot by cell type ranked by median activity score\n\n")

gd=FetchData(score_obj, c("cell_type", "ActivityScore1"))

gd$cell_type=factor(gd$cell_type, levels=rev(names(sort(tapply(gd[,"ActivityScore1"], gd$cell_type, median)))))

g=ggplot(gd, aes(x=cell_type, y=ActivityScore1)) +
  geom_violin(scale="width") + 
  geom_boxplot(outliers=FALSE, width=0.4, color="white", fill="black", linewidth=0.2) +
  ylab("Activity Score") + 
  scale_color_manual(values=c("black", "red")) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.x=element_blank(),
        plot.title = element_blank(),
        legend.position = "none")

ActivityScore_png=paste0(file_prefix, ".tabula.violin.cell_type.png")
ggsave(ActivityScore_png, g, width=15, height=7, units="in", dpi=300, limitsize=FALSE, bg="white")
include_graphics(ActivityScore_png)

cat("\n### UMAP of Activity score and cell types\n\n")

cat("Top 5 cell types with highest median activity score and all cell types with at least 1% of cells are shown in UMAP.\n")

gd=FetchData(score_obj, c("cell_type", "ActivityScore1"))
gd$cell_type=factor(gd$cell_type, levels=rev(names(sort(tapply(gd[,"ActivityScore1"], gd$cell_type, median)))))

view_cell_types=unique(c(levels(gd$cell_type)[1:5], unique(ct_obj$cell_type)))

view_obj=score_obj[, score_obj$cell_type %in% view_cell_types]

g1=FeaturePlot_scCustom(view_obj, 
      features='ActivityScore1', 
      pt.size=0.5,
      aspect_ratio=1,
      min.cutoff=quantile(view_obj@meta.data$ActivityScore1, 0.01),
      max.cutoff=quantile(view_obj@meta.data$ActivityScore1, 0.99)) +
      xlab("UMAP_1") + ylab("UMAP_2") + 
      theme(plot.title=element_blank())

g2=get_dim_plot_labelby(view_obj, label.by="cell_type") + 
   theme(plot.title=element_blank()) +
   guides(color = guide_legend(title = "Cell type", ncol = 2, override.aes = list(size=4)))

g=g1+g2 + plot_layout(ncol=2) & theme(legend.position = 'right')

tabula_score_celltype_umap_png=ActivityScore_png=paste0(file_prefix, ".tabula.umap.score.cell_type.png")
ggsave(tabula_score_celltype_umap_png, g, width=20, height=6.5, units="in", dpi=300, bg="white")
include_graphics(tabula_score_celltype_umap_png)
```
