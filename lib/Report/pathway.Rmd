```{r, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
load_install<-function(library_name, library_sources=library_name){
  if(!require(library_name, character.only = T)){
    BiocManager::install(library_sources, ask=FALSE)
  }
  library(library_name, character.only = T)
}

load_install("org.Hs.eg.db")
load_install("ComplexHeatmap")
load_install("clusterProfiler")
load_install("ReactomePA")

source("/nobackup/h_cqs/shengq2/program/ngsperl/lib/CQS/reportFunctions.R")
source("/nobackup/h_cqs/shengq2/program/ngsperl/lib/Annotation/enrichmentByClusterProfiler.R")
```

```{r}
#make sure all required variables are defined
stopifnot(exists("prefix"))

#target_genes is a list of genes that will be the testing set that we will look at where the background_genes is the full list of genes that were tested to get the target genes.
stopifnot(exists("target_genes"))
stopifnot(exists("background_genes"))
stopifnot(exists("organism"))
stopifnot(exists("OrgDb"))

#Options 
stopifnot(exists("pathway_analysis_sets"))
stopifnot(exists("fromType"))
stopifnot(exists("pathway_toType"))
```

```{r, error=FALSE, warning=FALSE}
if(!exists("pathway_width")){
  pathway_width=6
}
if(!exists("pathway_height")){
  pathway_height=4
}

cat("\n\n## Pathway Analysis \n\n")
res<-do_pathway(genes=target_genes,
                universe=background_genes,
                modules=pathway_analysis_sets,
                organism=organism,
                fromType=fromType,
                toType=pathway_toType,
                OrgDb=OrgDb)
dataForPlotList=res$dataForPlot

rmd=""
pname=pathway_analysis_sets[1]
for(pname in pathway_analysis_sets){
  lst=show_pathway(
    dataForPlotList=dataForPlotList,
    pname=pname,
    prefix=prefix, 
    pathway_width=pathway_width, 
    pathway_height=pathway_height)

  rmd=paste0(rmd, "\n\n### ", pname, "\n\n")
  if(nrow(lst$res_tbl) == 0){
    rmd=paste0(rmd, "No enriched pathways found.\n\n")
  }else{
    rmd=paste0(rmd, getTable(lst$csv))
  }

  if(is.null(lst$png)){
    rmd=paste0(rmd, "No valid pathways found.\n\n")
  }else{
    rmd=paste0(rmd, getFigure_width_height(lst$png, fig.width=pathway_width, fig.height=pathway_height))
  }
}
writeLines(rmd, paste0(prefix,"_pathway.rmd"))
```

```{r child=paste0(prefix,"_pathway.rmd")}
```
