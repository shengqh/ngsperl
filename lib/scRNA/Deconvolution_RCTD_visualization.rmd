---
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
output: 
  rmdformats::readthedown:
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo=FALSE,  
                      message=FALSE, 
                      warning=FALSE, 
                      results = 'asis', 
                      fig.width=7, 
                      fig.height = 7,
                      tidy = TRUE, 
                      tidy.opts = list(comment = FALSE))
```

```{css, echo=FALSE}
#content{
    max-width:1920px;
}
```

```{r data, echo = FALSE}
library(sf)
library(ggplot2)
library(viridis)
library(RColorBrewer)

source("reportFunctions.R")
source("scRNA_func.r")
source("Deconvolution_functions.R")

options(future.globals.maxSize = 600000 * 1024^2)
options(future.seed = TRUE)

myoptions<-read_file_map("fileList2.txt", do_unlist=FALSE)
email=myoptions$email
affiliation=get_affiliation(myoptions)

sample_name=fread("fileList1.txt", header=FALSE)$V2[1]
paths_CS=fread("fileList1.txt", header=FALSE)$V1[1]

rctd_list=c("Spatial.Polygons"=paths_CS)
if(file.exists("fileList3.txt")){
  paths_8u=read_file_map("fileList3.txt", header=FALSE)[[sample_name]]
  rctd_list=c(rctd_list, "Spatial.008um"=paths_8u)
}
```

---
title: "RCTD Visualization - `r sample_name`"
author:
- name: `r email`
  affiliation: `r affiliation`
---

```{r}
library(Seurat)
library(ggplot2)
library(ggpubr)
library(patchwork)

spatial_list=lapply(rctd_list, readRDS)

for(name in names(spatial_list)) {
  spatial_list[[name]]@meta.data$RCTD1_first_type_slim = gsub("^\\d+\\s+:\\s+", "", spatial_list[[name]]$RCTD1_first_type)
}

get_compare_tbl <- function(spatial_list, feature){
  tbl_list=lapply(names(spatial_list), function(x){
    tbl = get_freq_table(spatial_list[[x]]@meta.data, feature) 
    colnames(tbl)[2] = paste0(x, "_Count")  
    return(tbl)
  })
  compare_tbl = purrr::reduce(tbl_list, merge, by=feature, all=TRUE)
  compare_tbl = compare_tbl |> dplyr::arrange(desc(!!sym(names(compare_tbl)[2])))
  return(compare_tbl)
}
```

# Number of spots detected by RCTD

## Number of categorized spots detected by RCTD

By default, only the spots with at least 100 UMIs are kept for RCTD deconvolution.

```{r}
print_table(get_compare_tbl(spatial_list, "RCTD1_spot_class"), row.names=FALSE)
```

## Number of cell types detected by RCTD

```{r}
print_table(get_compare_tbl(spatial_list, "RCTD1_first_type_slim"), row.names=FALSE)
```

## Number of clustered cell types detected by RCTD

```{r}
print_table(get_compare_tbl(spatial_list, "RCTD1_first_type"), row.names=FALSE)
```

```{r}
if("Spatial.008um" %in% names(spatial_list)){
  cur_obj = spatial_list[["Spatial.008um"]]
}else{
  cur_obj = spatial_list[["Spatial.Polygons"]]
}

tissue_image = SpatialPlot( object = cur_obj, 
                            image.alpha = 1, 
                            alpha = c(0, 0)) + 
              ggtitle(paste0("Tissue : ", sample_name)) +
              theme(legend.position = "none",
                    plot.title = element_text(hjust = 0.5),
                    panel.border = element_rect(colour = "black", fill=NA, linewidth=1))

first_type_names = table(unlist(lapply(spatial_list, function(x) x$RCTD1_first_type))) |> sort(decreasing=TRUE) |> names()
first_type_colors = get_colors(first_type_names)

first_type_slim_names = table(unlist(lapply(spatial_list, function(x) x$RCTD1_first_type_slim))) |> sort(decreasing=TRUE) |> names()
first_type_slim_colors = get_colors(first_type_slim_names)

for(name in names(spatial_list)) {
  spatial_list[[name]]$RCTD1_first_type <- factor(spatial_list[[name]]$RCTD1_first_type, levels=first_type_names)
  spatial_list[[name]]$RCTD1_first_type_slim <- factor(spatial_list[[name]]$RCTD1_first_type_slim, levels=first_type_slim_names)
  Idents(spatial_list[[name]]) <- "RCTD1_first_type"
}

has_first_type_slim = length(first_type_names) != length(first_type_slim_names)
```

# ImageDimPlot vis

```{r}
get_image_dimplot_vis <- function(tissue_image, spatial_list, cur_cell_type_col, cur_cell_type_colors, sample_name){
  plots <- list("Tissue Image" = tissue_image)
  for(assay in names(spatial_list)) {
    cur_obj = spatial_list[[assay]]

    g = get_image_dim_plot( obj = cur_obj, 
                            assay = assay, 
                            group.by = cur_cell_type_col, 
                            colors = cur_cell_type_colors, 
                            title = assay)

    plots[[assay]] <- g
  }

  vis_png = save_vis_png(plots, sample_name, cur_cell_type_colors, cur_cell_type_col, "ImageDimPlot")
  return(vis_png)
}
```

```{r eval=has_first_type_slim}
cat("## Summarized RCTD predicted cell types\n")
vis_png = get_image_dimplot_vis(tissue_image, spatial_list, "RCTD1_first_type_slim",first_type_slim_colors, sample_name)
include_graphics(vis_png)
```

## RCTD predicted cell types

```{r}
vis_png = get_image_dimplot_vis(tissue_image, spatial_list, "RCTD1_first_type", first_type_colors, sample_name)
include_graphics(vis_png)
```

# SpatialDimPlot vis

```{r}
get_spatial_dimplot_vis <- function(tissue_image, spatial_list, cur_cell_type_col, cur_cell_type_colors, sample_name){
  plots <- list("Tissue Image" = tissue_image)
  name = names(spatial_list)[2]
  for(name in names(spatial_list)) {
    cur_obj = spatial_list[[name]]
    Idents(cur_obj) <- cur_cell_type_col

    if(grepl("Polygons", name)) {
      title <- "Cell Segmentation"
    } else {
      title <- "8uM Bin"
    }

    pt.size.factor = ifelse(grepl("Polygons", name), 0.5, 12)

    g = SpatialDimPlot( cur_obj, 
                        cols = cur_cell_type_colors, 
                        image.alpha = 0.2,
                        pt.size.factor = pt.size.factor) + 
      ggtitle(label = title) + 
      theme(plot.title = element_text(hjust = 0.5), 
            panel.border = element_rect(colour = "black", fill=NA, linewidth=1))
    plots[[name]] <- g
  }

  vis_png = save_vis_png(plots, sample_name, cur_cell_type_colors, cur_cell_type_col, "SpatialDimPlot", legend_ncol=1)
  return(vis_png)
}
```

```{r eval=has_first_type_slim}
cat("## Summarized RCTD predicted cell types\n")
vis_png = get_spatial_dimplot_vis(tissue_image, spatial_list, "RCTD1_first_type_slim", first_type_slim_colors, sample_name)
include_graphics(vis_png)
```

## RCTD predicted cell types

```{r}
vis_png = get_spatial_dimplot_vis(tissue_image, spatial_list, "RCTD1_first_type", first_type_colors, sample_name)
include_graphics(vis_png)
```

# Individual RCTD predicted cell type

```{r}
feature_content=""

cur_cell_type_title = "RCTD predicted cell types"
cur_cell_type_col = "RCTD1_first_type"
cur_cell_type_colors = first_type_colors

feature_set = paste0("RCTD2_", names(cur_cell_type_colors))
feature = feature_set[1]
for(feature in feature_set){
  celltype=gsub("^RCTD2_", "", feature)
  celltype_fn=celltype_to_filename(celltype)
  plots <- list("Tissue Image" = tissue_image)
  for(name in names(spatial_list)) {
    #cat("name: ", name, "\n")
    is_polygons = grepl("Polygons", name)
    if(is_polygons) {
      fov_name <- "slice1.polygons"
      title <- "Cell Segmentation"
      adjust_func <- adjust_ImagePlot_Polygons
    } else {
      fov_name <- "slice1.008um"
      title <- "8uM Bin"
      adjust_func <- adjust_ImagePlot_Bins
    }

    cur_obj = spatial_list[[name]]
    Idents(cur_obj) <- cur_cell_type_col

    # in case some small cell type might not be detected in one of the assays
    if(feature %in% colnames(cur_obj@meta.data)){
      g = ImageFeaturePlot( object = cur_obj, 
                            features = feature,
                            fov = fov_name, 
                            max.cutoff = "q95",
                            border.size = NA,
                            axes = F, 
                            dark.background = F, 
                            coord.fixed = T) + 
        scale_fill_gradientn(colours = turbo(n = 256)) +
        ggtitle(label = title) + 
        theme(plot.title = element_text(hjust = 0.5), 
              panel.border = element_rect(colour = "black", fill=NA, linewidth=1))

      g = adjust_func(g)

      plots[[name]] <- g
    }
  }

  vis_png = save_vis_png(plots, sample_name, cur_cell_type_colors, cur_cell_type_col, paste0("ImageFeaturePlot.", celltype_fn), legend_ncol=1, legend_title=TRUE)
  feature_content = paste0(feature_content, "\n## ", celltype, "\n\n")
  feature_content = paste0(feature_content, getFigure(vis_png))
}
feature_rmd = paste0(sample_name, ".RCTD_celltype_features.rmd")
writeLines(feature_content, con = feature_rmd)
```

```{r child=feature_rmd}
```

# Session Info

```{r}
print_table(get_packages_table(), byDT=TRUE, row.names=FALSE)
```
