---
title: "QC and Cell Type Annotation"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
output: 
  rmdformats::readthedown:
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,  message=FALSE, warning=FALSE, results = 'hide', fig.width=7, fig.height = 7,tidy = TRUE, tidy.opts = list(comment = FALSE))
```

```{css, echo=FALSE}
#content{
    max-width:1920px;
}
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#load the library and set the parameters and load our own function
library(Seurat)
library(data.table)
library(dplyr)
library(ggplot2)
library(pheatmap)
library(RCurl)
library(knitr)
library(kableExtra)
source("scRNA_func.r")
source("reportFunctions.R")
```

```{r, echo=FALSE}

cat("\n\n## Files Parameters\n\n")

#raw scRNAseq data files and clinical information
#work directory to save or load objectlist, objectintegrated and integratedmarkers; the raw files are in workdir/raw

option_table<-read.table("fileList2.txt", sep="\t", stringsAsFactors = F)
myoptions<-split(option_table$V1, option_table$V2)
print(kable(option_table))
```


```{r echo=FALSE}
#raw data file locations
SampleInfos<-read.table("fileList1.txt", stringsAsFactors = F)
colnames(SampleInfos)<-c("countfile", "SampleId")

samples<-SampleInfos$SampleId

if(file.exists('fileList3.txt')){
  hto_samples<-read.table('fileList3.txt', stringsAsFactors = F)
  hto_map=split(hto_samples$V1, hto_samples$V2)
  
  tag_tb<-read.table(myoptions$hto_sample_file, sep="\t", stringsAsFactors = F, header=T)

  samples<-samples[!(samples %in% tag_tb$File)]
  samples<-c(samples, tag_tb$Sample)
}
```

```{r echo=FALSE}
resFile<-"samples.Rmd"
figureRmd<-function(samples){
  result<-""
  for(cur_sample in samples){
    if(!file.exists(paste0("details/", cur_sample, ".qc1.png"))){
      next
    }
    result<-paste0(result, paste0("\n\n# ", cur_sample, "\n\n"))

    result<-paste0(result, "\n## QC1\n\n")
    result<-paste0(result, getFigure(paste0(cur_sample, ".qc1.png"), TRUE))
    result<-paste0(result, "\n## QC2\n\n")
    result<-paste0(result, getFigure(paste0(cur_sample, ".qc2.png"), TRUE))
    result<-paste0(result, "\n## QC3\n\n")
    result<-paste0(result, getFigure(paste0(cur_sample, ".qc3.png"), TRUE))
    result<-paste0(result, "\n## QC4\n\n")
    result<-paste0(result, getFigure(paste0(cur_sample, ".qc4.png"), TRUE))
    result<-paste0(result, "\n## QC5\n\n")
    result<-paste0(result, getFigure(paste0(cur_sample, ".qc5.png"), TRUE))
    result<-paste0(result, "\n## QC6\n\n")
    result<-paste0(result, getFigure(paste0(cur_sample, ".qc6.png"), TRUE))
    result<-paste0(result, "\n## QC7\n\n")
    result<-paste0(result, getFigure(paste0(cur_sample, ".qc7.png"), TRUE))
    result<-paste0(result, "\n## heatmap\n\n")
    result<-paste0(result, getFigure(paste0(cur_sample, ".heatmap.png"), TRUE))
    result<-paste0(result, "\n## Marker genes\n\n")
    result<-paste0(result, getFigure(paste0(cur_sample, ".bubble.png"), TRUE))
  }
  return(result)
}
cat(figureRmd(samples), file=resFile)

```

```{r, child=resFile} 
```

```{r echo=FALSE}
cat("\n\n# Sample summary\n")
object.list<-readRDS("objectlist.rds")
stats<-lapply(object.list, function(x){unlist(x$preprocess)})
stats_df<-data.frame(do.call(rbind, stats))
colnames(stats_df)<-gsub("preprocess.","",colnames(stats_df))
print(kable(stats_df))
```
