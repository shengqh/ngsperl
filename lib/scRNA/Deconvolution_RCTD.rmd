---
title: "RCTD Visium HD Visualization Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmdformats::readthedown:
    toc_depth: 3
    code_folding: hide
    number_sections: true
---

```{css, echo=FALSE}
#content{
    max-width:1920px;
}
```

```{r eval=FALSE, include=FALSE}
#For DEBUGGING ONLY
setwd('/nobackup/h_vivian_weiss_lab/shengq2/20250812_VisiumHD_RCTD_test/RCTD/result/S12_SolidPTC_NCOA4RET')
```

```{r setup, include=FALSE}
library(knitr)

knitr::opts_chunk$set(
  echo=TRUE, 
  include=TRUE, 
  warning=FALSE, 
  message=FALSE, 
  error=FALSE,
  results="asis"
)

date_str = format(Sys.time(), "%Y%m%d")
```

# Introduction

This report is to visualize HD image from RCTD result.

```{r}
source('reportFunctions.R')
source('Deconvolution_functions.R')

load_install("ggplot2")
load_install("patchwork")
load_install("Seurat")

fileList=fread('fileList1.txt', header=FALSE)
sample_name=fileList$V2[1]
sample_folder=fileList$V1[1]
obj_file=paste0(sample_name, ".post_RCTD.RDS")

myoptions=read_file_map('fileList2.txt', do_unlist=FALSE)

image.alpha=to_numeric(myoptions$image.alpha, 0.3)
pt.size.factor=to_numeric(myoptions$pt.size.factor, 10)
legend_point_size=to_numeric(myoptions$legend.point.size, 3)

email=myoptions$email
affiliation=get_affiliation(myoptions)
```

---
title: "RCTD - `r sample_name`"
author:
- name: `r email`
  affiliation: `r affiliation`
---

# RCTD Result

- RCTD1_Class/spot_class: classification in doublet mode
  - “singlet” (1 cell type on pixel)
  - “doublet_certain” (2 cell types on pixel)
  - “doublet_uncertain” (2 cell types on pixel, but only confident of 1)
  - “reject” (no prediction given for pixel).
- RCTD1_Label1/first_type: the first cell type predicted on the bead (for all spot_class conditions except “reject”).
- RCTD2_Label2/second_type: the second cell type predicted on the bead for doublet spot_class conditions (not a confident prediction for “doublet_uncertain”).
- <mark>Typically, reject pixels should not be used, and doublet_uncertain pixels should only be used for applications that do not require knowledge of all cell types in a pixel.</mark>

You may want to have a look at RCTD vignette for more details:

https://raw.githack.com/dmcable/RCTD/dev/vignettes/spatial-transcriptomics.html

```{r}
obj=readRDS(obj_file)

obj@meta.data$log_nCount_Spatial=log(obj$nCount_Spatial.008um+1)
obj@meta.data$RCTD1_Label1 = factor_by_count(obj@meta.data$RCTD1_Label1)

# Add coordinate for plotting directly with ggplot2
spatialCoords <- GetTissueCoordinates(
  obj,
  scale = "lowres",
  cols = c("imagecol", "imagerow")
) |>
  dplyr::mutate(xx=x,
                x=y,
                y=-xx) |> #rotate x and y, then reverse y for plot, otherwise, the tissue image will not match with plot
  dplyr::select(x, y)

obj = AddMetaData(obj, spatialCoords)

ct_tbl=get_freq_table(obj@meta.data, "RCTD1_Label1")

ct_df=data.frame(celltype_col=grep("RCTD2_", colnames(obj@meta.data), value=TRUE)) |>
  dplyr::mutate(celltype_name=gsub("RCTD2_", "", celltype_col)) |>
  merge(ct_tbl, by.x="celltype_name", by.y="RCTD1_Label1", all.x=TRUE) |>
  dplyr::mutate(celltype_label=paste0(celltype_name, " (", count, ")")) |>
  dplyr::arrange(desc(count))

feature_colors=rev(hcl.colors(9, "Rocket"))

theme_box = function(...) {
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.key.width=unit(0.5, "lines"),
        legend.key.height=unit(1, "lines"),
        ...)
}
```

Let's look at the RCTD class classfication result.

```{r}
class_tbl=get_freq_table(obj@meta.data, "RCTD1_Class")
print_table(class_tbl, byDT=FALSE, row.names=FALSE)
```

# Singlet from RCTD

Let's look at the singlet only.

```{r}
singlet_cells=colnames(obj)[obj$RCTD1_Class=="singlet"]
singlet_obj=subset(obj, cells=singlet_cells)

tb=get_freq_table(singlet_obj@meta.data, "RCTD1_Label1")
print_table(tb, byDT=FALSE, row.names=FALSE)

tb1 = tb[tb$count > 0.01 * sum(tb$count), ]
singlet_obj=subset(singlet_obj, cells=colnames(singlet_obj)[singlet_obj$RCTD1_Label1 %in% tb1$RCTD1_Label1])
singlet_obj@meta.data$RCTD1_Label1=factor(as.character(singlet_obj$RCTD1_Label1), levels=tb1$RCTD1_Label1)

all_cell_types=tb1$RCTD1_Label1
set.seed(20250903)
celltype_colors <- base::sample(hcl.colors(length(all_cell_types), "Spectral"))
names(celltype_colors) = all_cell_types
```

```{r}
g1 = SpatialPlot(obj, image.alpha = 1, stroke = 0) + 
  theme_box(plot.title=element_blank(),
            legend.position = "none")

g2 = SpatialFeaturePlot(obj, features="log_nCount_Spatial", image.alpha=image.alpha, pt.size.factor=pt.size.factor) +
  scale_fill_gradientn("log(nCount)", colors=feature_colors) +
  theme_box(plot.title=element_blank(), 
            legend.position="right")

g3 = SpatialDimPlot(singlet_obj, group.by="RCTD1_Label1", image.alpha=image.alpha, pt.size.factor=pt.size.factor) +
  scale_fill_manual(values=celltype_colors) +
  theme_box(plot.title=element_blank(),
            legend.position="right") +
  guides(fill = guide_legend(title="Number of\nsinglet bin> 1%", override.aes = list(size = legend_point_size)))

g = g1 + g2 + g3 + plot_layout(ncol=3)
qc_png=paste0(sample_name, ".tissue_log_ncount_RCTD_singlet.png")
ggsave(qc_png, g, width=11, height=3, dpi=300, units="in", bg="white")
include_graphics(qc_png)
```

# RCTD weights of valid bins

Based on RCTD vignette, we removed all "rejected" bins from the object for down-stream analysis.

```{r}
valid_cells=colnames(obj)[obj$RCTD1_Class != "reject"]
valid_obj=subset(obj, cells=valid_cells)
saveRDS(valid_obj, paste0(sample_name, ".post_RCTD.valid.RDS"))
valid_celltype_tbl=get_freq_table(valid_obj@meta.data, "RCTD1_Label1")
print_table(valid_celltype_tbl, byDT=FALSE, row.names=FALSE)
```

```{r}
num_celltype=nrow(ct_df)
ncol=3
nrow=ceiling(num_celltype/ncol)

rctd_celltype_width=to_numeric(myoptions$rctd_celltype_width, 5 * ncol)
rctd_celltype_height=to_numeric(myoptions$rctd_celltype_height, 4 * nrow)
```

```{r eval=FALSE, include=FALSE}
cat("\n\n## Weights plot without image background\n\n")
glist_noimage = lapply(1:num_celltype, \(i) my_plotCoords(valid_obj@meta.data, 
                                                          annotate=ct_df$celltype_col[i], 
                                                          point_size=0.3, 
                                                          legend_title=ct_df$celltype_label[i],
                                                          numeric_feature_colors=feature_colors))

g = glist_noimage |>
  wrap_plots(nrow=nrow) & 
  coord_fixed() &
  theme(plot.title=element_text(hjust=0.5, face="bold"), 
        legend.title=element_blank(),
        legend.key.width=unit(0.5, "lines"),
        legend.key.height=unit(1, "lines")) 

rctd_celltype_png=paste0(sample_name, ".RCTD_weights_noimage.png")
ggsave(rctd_celltype_png, g, width=rctd_celltype_width, height=rctd_celltype_height, dpi=300, units="in", bg="white")
include_graphics(rctd_celltype_png)
```

## Weights plot with image background

```{r}
glist_image = lapply(1:num_celltype, \(i) SpatialFeaturePlot( valid_obj, 
                                                              features=ct_df$celltype_col[i], 
                                                              image.alpha=image.alpha, 
                                                              pt.size.factor=pt.size.factor) +
                                          scale_fill_gradientn(colours=feature_colors) +
                                          ggtitle(ct_df$celltype_label[i]) +
                                          coord_fixed() +
                                          theme_box(plot.title=element_text(hjust=0.5, face="bold"), 
                                                    legend.title=element_blank(),
                                                    legend.position="right"))

g = glist_image |>
  wrap_plots(nrow=nrow) & 
  theme(legend.key.width=unit(0.5, "lines"),
        legend.key.height=unit(1, "lines")) 

rctd_celltype_png=paste0(sample_name, ".RCTD_weights_image.png")
ggsave(rctd_celltype_png, g, width=rctd_celltype_width, height=rctd_celltype_height, dpi=300, units="in", bg="white")
include_graphics(rctd_celltype_png)
```

```{r eval=FALSE, include=FALSE}
weights_content=""

i=1
for(i in 1:nrow(ct_df)) {
  ct_name=ct_df$celltype_name[i]
  weights_content=paste0("\n\n", weights_content, "## ", ct_name, "\n\n")

  g=glist[[i]] + ggtitle(ct_df$celltype_label[i]) +
    theme(plot.title=element_text(hjust=0.5, face="bold", size=10), 
          legend.title=element_blank())

  ct_file=to_filename(ct_name)
  ct_png=paste0(sample_name, ".weights.", ct_file, ".png")
  ggsave(ct_png, g, width=5, height=4, dpi=300, units="in", bg="white")

  weights_content=paste0("\n\n", weights_content, getFigure(ct_png))
}

weights_rmd="weights.rmd"
writeLines(weights_content, weights_rmd)
```
