---
title: "Seurat optimal resolution result"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
output: 
  rmdformats::readthedown:
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library(kableExtra)
knitr::opts_chunk$set(echo=FALSE,  message=FALSE, warning=FALSE, results = 'asis', fig.width=7, fig.height = 7,tidy = TRUE, tidy.opts = list(comment = FALSE))
source("scRNA_func.r")
```

```{css, echo=FALSE}
#content{
    max-width:1920px;
}
```

```{r data, include=FALSE}
source("reportFunctions.R")

options_table<-read.table("fileList1.txt", sep="\t", header=F, stringsAsFactors = F)
myoptions<-split(options_table$V1, options_table$V2)

outFile=myoptions$task_name
detailFile=paste0("details/", outFile)

cta_file=paste0(outFile, ".cta.png")
```

# Pre selection

## Cell type UMAP

```{r, echo=FALSE}
check_and_include_graphics(paste0(outFile, ".pre.umap.png"))
```

# Post selection

## sub-clustering UMAP

```{r, echo=FALSE}
cts<-readLines(paste0(outFile, ".orig_cell_types.txt"))

resFile<-"sub_umap.Rmd"
figureRmd<-function(cts){
  result<-""
  ct<-cts[1]
  for(ct in cts){
    result<-paste0(result, paste0("\n\n### ", ct, "\n\n"))

    umap_png<-paste0(outFile, ".", celltype_to_filename(ct), ".umap.png")
    dot_png<-paste0(outFile, ".", celltype_to_filename(ct), ".dot.png")
    sample_png<-paste0(outFile, ".pre.", celltype_to_filename(ct), ".cell.png")

    result<-paste0(result, getFigure(umap_png, TRUE))
    result<-paste0(result, getFigure(dot_png, TRUE))
    result<-paste0(result, getFigure(sample_png, TRUE))
  }
  return(result)
}
cat(figureRmd(cts), file=resFile)
```

```{r, child=resFile} 
```

## Cell type level

### UMAP

```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".cell_type.umap.png"))
```

### Marker genes

```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".cell_type.dot.png"))
```

### Sample / Cell type

```{r, echo=FALSE}
scts<-read.csv(paste0(detailFile, ".cell_type.sample_celltype.csv"), check.names=F, row.names=1)
print(kable_styling(kable(t(scts), caption=tabRef("sct_count", "Cell count in each cell type of each sample"))))
```
```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".cell_type.sample_celltype.png"))
```
```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".cell_type.celltype_sample.png"))
```

### Cell type individual UMAP 

```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".cell_type.cell.png"))
```

### Cell type top 10 heatmap

```{r, echo=FALSE}
include_graphics(paste0(outFile, ".cell_type.top10.heatmap.png"))
```

## Sub cluster level

### UMAP

```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".seurat_cell_type.umap.png"))
```

### Marker genes

```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".seurat_cell_type.dot.png"))
```

```{r, echo=FALSE, eval=file.exists(cta_file)}
cat("\n### Cell type annotation score\n\n")
include_graphics(cta_file)
```

### Sample / cell subtype

```{r, echo=FALSE}
scts<-read.csv(paste0(detailFile, ".seurat_cell_type.sample_celltype.csv"), check.names=F, row.names=1)
print(kable_styling(kable(t(scts), caption=tabRef("sct_count_sub", "Cell count in each sub cluster of each sample"))))
```
```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".seurat_cell_type.sample_celltype.png"))
```
```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".seurat_cell_type.celltype_sample.png"))
```

### Cell subtype individual UMAP 

```{r, echo=FALSE}
include_graphics(paste0(detailFile, ".seurat_cell_type.cell.png"))
```

### Cell subtype top 10 heatmap

```{r, echo=FALSE}
include_graphics(paste0(outFile, ".seurat_cell_type.top10.heatmap.png"))
```
