---
title: "Seurat sub clustering analysis"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
output: 
  rmdformats::readthedown:
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library(kableExtra)
knitr::opts_chunk$set(echo=FALSE,  message=FALSE, warning=FALSE, results = 'asis', fig.width=7, fig.height = 7,tidy = TRUE, tidy.opts = list(comment = FALSE))
```

```{css, echo=FALSE}
#content{
    max-width:1920px;
}
```

```{r data, include=FALSE}
source("reportFunctions.R")

options_table<-read.table("fileList1.txt", sep="\t", header=F, stringsAsFactors = F)
myoptions<-split(options_table$V1, options_table$V2)

outFile=myoptions$task_name

post_file=paste0(outFile, ".post_rename.umap.png")

cts<-readLines(paste0(outFile, ".cell_types.txt"))

files<-read.csv(paste0(outFile, ".files.csv"))

getFigure<-function(filepath, in_details=TRUE){
  fname = ifelse(in_details, paste0("details/", basename(filepath)), basename(filepath))
  return(paste0("```{r,echo=FALSE,results='asis'}\ncheck_and_include_graphics('", fname, "')\n```\n\n"))
}

resFile<-"subcluster.Rmd"
figureRmd<-function(cts, files){
  result<-""
  celltypes<-rev(unique(files$celltype))
  celltypes<-unique(c(celltypes, cts))
  idx=1
  for(idx in c(1:length(celltypes))){
    celltype=celltypes[idx]
    result<-paste0(result, paste0("\n\n# ", celltype, "\n\n"))

    ct_tbl<-files[files$celltype==celltype,]
    if(nrow(ct_tbl) == 0){
      result<-paste0(result, "\n\nAll resolutions have only 1 cluster. Set resolution to 0 in selection table.\n\n")
      next
    }

    resolutions<-unique(ct_tbl$resolution)
    
    idy = 1
    for(idy in c(1:length(resolutions))){
      res=resolutions[idy]

      result<-paste0(result, paste0("\n\n## Resolution ", res, "\n\n"))
      res_tbl=ct_tbl[ct_tbl$resolution == res,]

      res_map=split(res_tbl$file, res_tbl$type)

      heatmap=res_map$heatmap
      if(file.info(heatmap)$size > 20000){
        result<-paste0(result, "### Marker genes\n\n")
        result<-paste0(result, getFigure(heatmap))
      }

      result<-paste0(result, "### UMAP\n\n")
      umap=res_map$umap
      result<-paste0(result, getFigure(umap))

      cur_prefix = gsub(".umap.png$", "", umap)

      cta_png = paste0(cur_prefix, ".cta.png")
      if(file.exists(cta_png)){
        result<-paste0(result, "### Cell type annotation score\n\n")
        result<-paste0(result, getFigure(cta_png))
      }

      if("dot" %in% names(res_map)){
        result<-paste0(result, "### Bubble plot\n\n")
        dot=res_map$dot
        result<-paste0(result, getFigure(dot))
      }

      result<-paste0(result, "### Sample/Cluster\n\n")
      bar=res_map$bar
      result<-paste0(result, getFigure(bar))
    }
  }
  return(result)
}
cat(figureRmd(cts, files), file=resFile)

```

```{r, echo=FALSE, eval=file.exists(post_file)}
cat("\n\n# Post renaming cell type, before sub-clustering\n\n")
include_graphics(post_file)
```

```{r, child=resFile} 
```

