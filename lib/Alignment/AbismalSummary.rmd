---
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmdformats::readthedown:
    toc_depth: 3
    code_folding: hide
    number_sections: true
---

```{css, echo=FALSE}
#content{
    max-width:1920px;
}
```

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
library(tibble)
library(dplyr)

knitr::opts_chunk$set(
  echo=TRUE, 
  include=TRUE, 
  warning=FALSE, 
  message=FALSE, 
  results="asis"
)
```

```{r}
source('reportFunctions.R')

meth_files=fread('fileList1.abismal.txt', header=FALSE, data.table=FALSE)

myoptions = read_file_map('fileList2.abismal.txt', do_unlist=FALSE)
task_name=myoptions$task_name
email=myoptions$email
affiliation=myoptions$affiliation
```

---
title: "`r task_name` - Abismal Summary"
author: "`r email`"
---

# Reads mapped

```{r}
mapstats_files = meth_files |> dplyr::filter(grepl("mapstats", V1))

mapstats_lst = apply(mapstats_files, 1, function(row) {
  file_path = row[1]  
  sample_name = row[2]
  df = fread(file_path, header=FALSE, sep=":", data.table=FALSE) |>
    dplyr::rename("Metric"="V1", "Value"="V2") |>
    dplyr::mutate(Sample=sample_name) 
  return(df)
})
mapstats_df = do.call(rbind, mapstats_lst) 
```

```{r}
mapped_levels = c("num_unique", "num_ambiguous", "num_unmapped" )
mapped = mapstats_df |> dplyr::filter(Metric %in% mapped_levels) |>
  dplyr::mutate(Metric = factor(Metric, levels=mapped_levels))

g = ggplot(mapped, aes(x=Sample, y=as.numeric(Value), fill=Metric)) + 
  geom_bar(stat="identity", position = "stack", width=0.5) +
  theme_classic() +
  labs(y="Number of reads", title="Read mapping summary") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5),
        axis.title.x=element_blank())

width=max(6, length(unique(mapped$Sample))*0.3)
reads_mapped_bar_png=paste0(task_name, ".reads_mapped.bar.png")
ggsave(reads_mapped_bar_png, g, width=width, height=3, units="in", dpi=300, bg="white")
include_graphics(reads_mapped_bar_png)
```

# Read on target

```{r}
hsmetrics_files = meth_files |> dplyr::filter(grepl("hs_metrics", V1))

hsmetrics_lst = apply(hsmetrics_files, 1, function(row) {
  file_path = row[1]  
  sample_name = row[2]
  df = fread(file_path, data.table=FALSE) |>
    dplyr::mutate(Sample=sample_name) 
  return(df)
})
hsmetrics_df = do.call(rbind, hsmetrics_lst) 
```

```{r}
g = ggplot(hsmetrics_df, aes(x=Sample, y=as.numeric(PCT_OFF_BAIT))) + 
  geom_bar(stat="identity", width=0.5) +
  theme_classic() +
  labs(y="PCT_OFF_BAIT", title="Reads off bait") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5),
        axis.title.x=element_blank())

width=max(4, length(unique(hsmetrics_df$Sample))*0.2)
reads_off_bait_bar_png=paste0(task_name, ".reads_off_bait.bar.png")
ggsave(reads_off_bait_bar_png, g, width=width, height=2.5, units="in", dpi=300, bg="white")
include_graphics(reads_off_bait_bar_png)
```

# Final unique reads

```{r}
flagstat_files = meth_files |> dplyr::filter(grepl(".intervals.uniq.addqual.bam.flagstat", V1))

flagstat_lst = apply(flagstat_files, 1, function(row) {
  file_path = row[1]  
  sample_name = row[2]
  df = fread(file_path, sep=" ", header=FALSE, data.table=FALSE) |>
    dplyr::mutate(Sample=sample_name) 
  return(df)
})
flagstat_df = do.call(rbind, flagstat_lst) |>
  dplyr::filter(V4=="primary")
```

```{r}
g = ggplot(flagstat_df, aes(x=Sample, y=as.numeric(V1))) + 
  geom_bar(stat="identity", width=0.5) +
  theme_classic() +
  labs(y="Unique reads", title="Final unique reads") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5),
        axis.title.x=element_blank())

width=max(4, length(unique(flagstat_df$Sample))*0.2)
final_unique_reads_bar_png=paste0(task_name, ".final_unique_reads.bar.png")
ggsave(final_unique_reads_bar_png, g, width=width, height=2.5, units="in", dpi=300, bg="white")
include_graphics(final_unique_reads_bar_png)
```

# Save the session information

```{r include=TRUE, echo=FALSE}
print_table(get_packages_table(), byDT=TRUE, row.names=F)
```


