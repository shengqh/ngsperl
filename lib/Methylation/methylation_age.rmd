---
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmdformats::readthedown:
    toc_depth: 3
    code_folding: hide
    number_sections: true
---

```{css, echo=FALSE}
#content{
    max-width:1920px;
}
```

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
library(tibble)
library(dplyr)

knitr::opts_chunk$set(
  echo=TRUE, 
  include=TRUE, 
  warning=FALSE, 
  message=FALSE, 
  results="asis"
)
```

```{r}
library(data.table)
library(dplyr)
library(methylKit)
#devtools::install_github("jmw86069/splicejam")
library(splicejam)
library(GenomicRanges)

source('reportFunctions.R')

meth_file=read_file_map('fileList1.age.txt', do_unlist=FALSE)[[1]]

myoptions = read_file_map('fileList2.age.txt', do_unlist=FALSE)

illumina_file=myoptions$probe_locus_file

task_name=myoptions$task_name
email=myoptions$email
affiliation=myoptions$affiliation

if(file.exists('fileList3.age.txt')){
  ages = fread('fileList3.age.txt', header=FALSE, data.table=FALSE) |>
    dplyr::rename("chronological_age"="V1", "Sample"="V2")
}else{
  ages = NULL
}
```

---
title: "`r task_name` - Methylation Age"
author: "`r email`"
---

# Read beta values

Read methylation data from `r basename(meth_file)` and calculate beta values.

The methylation data was generated by methylKit which is zero-based. 
We need to convert it to one-based GenomeRanges.

```{r}
filtered.cpg.meth=readRDS(meth_file)

get_beta_value<-function(filtered.cpg.meth){
  mat = getData(filtered.cpg.meth)  
  beta = mat[, filtered.cpg.meth@numCs.index]/ (mat[,filtered.cpg.meth@numCs.index] + mat[,filtered.cpg.meth@numTs.index] )
  colnames(beta)=filtered.cpg.meth@sample.ids

  result=cbind(mat[,1:3], beta) |>
    dplyr::mutate(start=start+1, end=end+1) |>
    dplyr::mutate(meth_id = paste(chr, start, sep = ":")) |>
    tibble::column_to_rownames("meth_id") 

  return(result)
}

cpg_bvalue_df<-get_beta_value(filtered.cpg.meth)  

betas = makeGRangesFromDataFrame(cpg_bvalue_df,
                         keep.extra.columns=TRUE,
                         ignore.strand=TRUE,
                         seqinfo=NULL,
                         seqnames.field=c("chr"),
                         start.field="start",
                         end.field=c("end"),
                         strand.field="strand",
                         starts.in.df.are.0based=FALSE)

print_table(cpg_bvalue_df |> head(), byDT=FALSE, row.names=FALSE, round_value=0)
```

# Read illumina annotation

Read illumina hg38 annotation from `r basename(illumina_file)`. It is one-based.

```{r}
edat=fread(illumina_file) |> dplyr::rename("Probe_ID"=Name)

illumina_grs = makeGRangesFromDataFrame(edat,
                                        keep.extra.columns=TRUE,
                                        ignore.strand=TRUE,
                                        seqinfo=NULL,
                                        seqnames.field=c("CHR"),
                                        start.field="MAPINFO",
                                        end.field="MAPINFO",
                                        strand.field="strand",
                                        starts.in.df.are.0based=FALSE)

print_table(edat |> head(), byDT=FALSE, row.names=FALSE, round_value=0)
```

# Annotate betas

Annotate beta values by capture regions, EPIC and Illumina annotation.

```{r}
probe_betas = subsetByOverlaps(betas, illumina_grs)
probe_betas = annotateGRfromGR(probe_betas, illumina_grs)

probe_betas_tbl = as.data.frame(probe_betas) |> 
  tibble::remove_rownames() |>
  tibble::column_to_rownames("Probe_ID") 

csv_file="probe_gene.csv"
write.csv(probe_betas_tbl, csv_file, row.names=TRUE, na="")

print_table(probe_betas_tbl |> head(), byDT=FALSE, row.names=TRUE, round_value=0)
```

Beta file with probe id has been saved to <mark>`r csv_file`</mark>.

# Dat cleaning

- Keep beta column only

```{r, echo=FALSE}
final_betas = probe_betas_tbl |> dplyr::select(contains("DY_"))
print_table(head(final_betas) |> head(), byDT=FALSE, row.names=TRUE, round_value=0)
```

# Calculate methylation age

```{r}
#devtools::install_github("yiluyucheng/dnaMethyAge")
library('dnaMethyAge')
clocks = availableClock()

discard_clocks=c("LevineM2018", "ShirebyG2020", "ZhangY2017", "LuA2019", "DunedinPACE", "McEwenL2019", "CBL_specific", "CBL_common", "Cortex_common", "epiTOC2", "LuA2023p1")
clocks = setdiff(clocks, discard_clocks)
```

Valid clocks: `r paste(clocks, sep=", ")`.

```{r message=FALSE, results='hide'}
pred_ages = lapply(clocks[1:2], function(clock_name){
  cat(clock_name, "\n")
  tryCatch(
        {
          pred_age <- methyAge(final_betas, clock=clock_name, fit_method='Linear')
          write.csv(pred_age, paste0(clock_name, ".csv"))
          return(pred_age)
        },
        error = function(cond) {
          return(cond)
        })
})
names(pred_ages)=clocks
saveRDS(pred_ages, rds_file)
```

```{r}
for(clock_name in clocks){
  pred_age=pred_ages[[clock_name]]
  if(is.string(pred_age)){
    cat("<mark>Failed:", pred_age, "</mark>\n\n")
  }else{
    pred_age$chronological_age=c(80, 0, 84, 0, 25, 0)
    print_table(pred_age, row.names=FALSE)
  }
}
```

# Save the session information

<pre>
```{r include=TRUE, echo=FALSE}
sessionInfo()
```
</pre>


