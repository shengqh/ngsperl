---
title: "GSEA Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
---

<style type="text/css">
    div.datatables { height: auto !important;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
library(ggplot2)
library(RColorBrewer)
library(reshape2)
library(DT)
library(RCurl)
library(htmltools)
library(knitr)

addLinkTag<-function(text,link) {
	result<-paste0("<a href='",link,"'>",text,"</a>")
	return(result)
}
addImageTag<-function(imageFile,width=NULL,height=NULL) {
	result<-paste0("<img src='",imageFile,"'")
	if (!is.null(height)) {
		result<-paste0(result," height='",height,"'")
	}
	if (!is.null(width)) {
		result<-paste0(result," width='",width,"'")
	}
	result<-paste0(result,"></img>")
	return(result)
}

myGetRelativePath<-function(path, root_dir) {
  prefix_dir = substr(path, 1, nchar(root_dir))
  if (prefix_dir == root_dir) {
    result = substr(path, nchar(root_dir)+2, nchar(path))
  }else{
    result = path
  }
  return(result)
}

processGesaTable<-function(gseaTableFile, rootDir,maxCategoryFdr=0.05,maxCategory=10,absLinkPath=FALSE) {
	rawTable<-read.delim(gseaTableFile,header=T,as.is=T)
	rawTableOut<-NULL
	i=2
	for (i in head(which(rawTable$FDR.q.val<=maxCategoryFdr),maxCategory)) {
	  cat(i)
		categoryName=rawTable[i,1]
		gseaUrl=paste0("http://software.broadinstitute.org/gsea/msigdb/cards/",categoryName)
		categoryNameInTable<-addLinkTag(text=categoryName,link=gseaUrl)
		
		#gseaWeb<-getURL("http://software.broadinstitute.org/gsea/msigdb/cards/HALLMARK_MITOTIC_SPINDLE")
		gseaWeb<-getURL(gseaUrl)
		temp<-strsplit(gseaWeb,"description|\\<td\\>")[[1]]
		j=grep("Brief",temp)
		categoryDescription<-gsub("^>","",temp[j+2])
		categoryDescription<-gsub("<\\/$","",categoryDescription)
		if (length(categoryDescription)==0) {
		  categoryDescription=NA
		}
		
    figurePath<-list.files(dirname(gseaTableFile),pattern=paste0("enplot_",categoryName),full.names=TRUE)[1]
		figurePath<-myGetRelativePath(figurePath,rootDir) #resultDir is outside this Rmd file, the location of result html file
		if (absLinkPath) {
		  reportPath<-paste0(dirname(gseaTableFile),"/",categoryName,".html")
		} else {
		  reportPathFolders<-strsplit(dirname(gseaTableFile),"[\\/|\\\\]+")[[1]]
		  reportPath<-paste0("./",reportPathFolders[length(reportPathFolders)-1],"/",reportPathFolders[length(reportPathFolders)],"/",categoryName,".html")
		}
		
		
		figurePathHtml<-addImageTag(figurePath,height=150,width=150)
#		figurePathHtml<-paste0("<img src='",figurePath,"' height='150' width='150'></img>")
		figurePathHtml<-addLinkTag(figurePathHtml,reportPath)
		rawTableOut<-rbind(rawTableOut,unlist(c(categoryNameInTable,categoryDescription,rawTable[i,c(4,5,6,8)],figurePathHtml)))
	}
	if (!is.null(rawTableOut)) {
	  	colnames(rawTableOut)[1:2]<-c("Name","Description")
	    colnames(rawTableOut)[7]<-c("Figure")
	}
	return(rawTableOut)
}


```

```{r,echo=FALSE,results='asis'}
root_dir = R.utils::getAbsolutePath(".")
resultDirs = list.dirs(root_dir,recursive=FALSE,full.names =TRUE)
resultDir=resultDirs[1]
for(resultDir in resultDirs){
  resultDirSubs<-list.dirs(resultDir,recursive=FALSE,full.names =TRUE)
  resultDirSub=resultDirSubs[1]
  for (resultDirSub in resultDirSubs) {
   	posTableFile<-list.files(resultDirSub,pattern="gsea_report_for_na_pos_\\d+\\.tsv$",full.names=TRUE)
   	negTableFile<-list.files(resultDirSub,pattern="gsea_report_for_na_neg_\\d+\\.tsv$",full.names=TRUE)
   	if (length(negTableFile)!=1) {
   		warning(paste0("Can't find positive-regulated GSEA table file"))
   	}
   	if (length(negTableFile)!=1) {
   		warning(paste0("Can't find negative-regulated GSEA table file"))
   	}
   	
   	rawTableOut<-processGesaTable(posTableFile, root_dir)
   	tableOne=datatable(rawTableOut,escape=c(-1,-2,-7))
   	print(kable(rawTableOut))

    rawTableOut<-processGesaTable(negTableFile, root_dir)
   	tableOne=datatable(rawTableOut,escape=c(-1,-2,-7))
   	print(kable(rawTableOut))
  }
}

```
